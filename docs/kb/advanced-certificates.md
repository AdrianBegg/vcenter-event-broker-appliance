---
layout: docs
toc_id: advanced-certificates
title: VMware Event Broker Appliance - Certificates
description: Updating Certificates
permalink: /kb/advanced-certificates
cta:
 description: Replacing the default self-signed TLS certificate in VMware Event Broke Appliance.
---

## Updating the TLS Certificate on VEBA

By default, the VMware Event Broker Appliance generates a self-signed TLS certificate that is used to support different web endpoints running on the appliance such as Stats (`/stats`), Status (`/status`), Logs (`/bootstrap`) and Events (`/events`). This will cause browsers to show the certificate as untrusted.

For organizations that require the use of a TLS certificate from a trusted authority, the VMware Event Broker Appliance provides an option for users to provide their certificate information during the OVF property configuration when deploying the virtual appliance.

In order to use a certificates from a trusted authority, please follow the steps outlined below.

### Assumptions

* Certificates from a trusted authority pre-downloaded onto your local desktop
    * The public/private key pair must exist before hand. The public key certificate must be .PEM encoded and match the given private key.

### Steps

In the example, the private key file is named `privateKey.key` and certificate file is named `certificate.crt`

1. Encode both the private key and the certificate file using base64 encoding.

Microsoft Windows (PowerShell)

```console
$privateKeyContent = Get-Content -Raw privateKey.key
$privateKeybase64 = [System.Convert]::ToBase64String([System.Text.Encoding]::ASCII.GetBytes($privateKeyContent))
Write-Host "Encoded Private Key:`n$privateKeybase64`n"

$certContent = Get-Content -Raw certificate.crt
$certbase64 = [System.Convert]::ToBase64String([System.Text.Encoding]::ASCII.GetBytes($certContent))
Write-Host "Encoded Certificate:`n$certbase64`n"

Encoded Private Key:
LS0tLS1CRUd......==


Encoded Certificate Key:
LS0tLS1CRUe......==
```

MacOS/Linux

```console
cat privateKey.key | base64

LS0tLS1CRUd......==

cat certificate.crt | base64

LS0tLS1CRUd......==
```

2. Using the output from the previous step, the base64 content can now be provided in `Custom TLS Certificate Configuration` section of the OVF property during the deployment of the VMware Event Broker Appliance.
    * Custom VMware Event Broker Appliance TLS Certificate Private Key (Base64)
    * Custom VMware Event Broker Appliance TLS Certificate Authority Certificate (Base64)

3. Power on the VMware Event Broker Appliance and ensure that the provided TLS certificate is now used instead of the auto-generated self-sign TLS certificate by opening a browser to one of the VMware Event Broker Appliance endpoints such as `/status`.

## Adding a Trusted Root Certificate to VEBA

For organizations that require the use of a Private or Enterprise Certificate Authority (CA) and wish to have full TLS trust when the VMware Event Broker Appliance is configured with a vCenter Server that has a TLS certificate generated by the internal CA, a root of trust must be established.

To support this use case, a post-deployment reconfiguration of the VMware Event Broker Appliance is required to import the trusted root certificate of your internal certificate authority. If this is not performed, you may see the following warning in the VMware Event Router logs when connecting to the configured vCenter Server.

```console
WARN    [VCENTER]       vcenter/vcenter.go:112  using potentially insecure connection to vCenter  {"address": "https://vcsa.primp-industries.local", "insecure": true}
```


In order to import your trusted root certificate, please follow the steps outlined below.

### Assumptions

* Pre-download your root certificates from your internal certificate, which must be .PEM encoded

In the example, the downloaded root certificate file is named `ca-root.crt`

### Steps

Step 1 - Transfer or copy the contents of the root certificate to the VMware Event Broker Appliance and create a new kubernetes configMap from that file.

```console
kubectl -n vmware-system create cm ca-root-cert --from-file ca-root.crt
```

Step 2 - Undeploy the VMware Event Router and delete the current configuration secret.

```console
kubectl -n vmware-system delete -f /root/config/event-router-k8s.yaml
kubectl -n vmware-system delete secret event-router-config
```

Step 3 - Edit `/root/config/event-router-k8s.yaml` and append the additional `volumenMount` and `volume` entry as shown in the snippet below.

```console
snip
...
          volumeMounts:
            - name: config
              mountPath: /etc/vmware-event-router/
              readOnly: true
            - name: ca-root-cert
              mountPath: /etc/vmware-event-router/ssl
              readOnly: true
      volumes:
        - name: config
          secret:
            secretName: event-router-config
        - name: ca-root-cert
          configMap:
            name: ca-root-cert
```

Step 4 - Edit `/root/config/event-router-config.yaml` and append the additional `certificates` section to the end of the file as shown in the snippet below.

```console
snip
...
metricsProvider:
  default:
    bindAddress: 0.0.0.0:8082
  name: veba-metrics
  type: default
certificates:
  rootCAs:
    - /etc/ssl/certs/ca-certificates.crt
    - /etc/vmware-event-router/ssl/ca-root.crt
```

> **Note:** If `insecureSSL` is set to `true`, please update that to `false` which will now ensure TLS verification is performed when connecting to your vCenter Server.

Step 5 - Recreate the VMware Event Router configuration and redeploy the VMware Event Router deployment.

```console
kubectl -n vmware-system create secret event-router-config
kubectl -n vmware-system apply -f /root/config/event-router-k8s.yaml
```

Step 6 - Verify the VMware Event Router pod is running successfully.

```console
kubectl -n vmware-system get pods
NAME                                   READY   STATUS    RESTARTS   AGE
tinywww-dd88dc7db-q6pzw                1/1     Running   0          166m
veba-rabbit-server-0                   1/1     Running   0          167m
veba-ui-8d6584f84-ckvwb                1/1     Running   0          166m
vmware-event-router-7759d8bffc-45c92   1/1     Running   0          37m
```

Lastly, you can also look at the VMware Event Router log and ensure that you no longer see the message `potentially insecure connection to vCenter`, which is what you would see if the connection was not trusted if you had TLS verified disabled. The following `DEBG` log entry should appear when the VMware Event Router is deployed with the debug flag.

```
kubectl -n vmware-system logs vmware-event-router-7759d8bffc-kt2jm

DEBUG   [VCENTER]       vcenter/vcenter.go:136  setting custom root CAs {"certificates": "/etc/ssl/certs/ca-certificates.crt:/etc/vmware-event-router/ssl/ca-root.crt"}
```

